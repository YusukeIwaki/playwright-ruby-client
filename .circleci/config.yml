version: 2.1

jobs:
  test-remote:
    docker:
      - image: cimg/ruby:3.4
      - image: mcr.microsoft.com/playwright:v1.56.1-noble
        command: /bin/sh -c "cd /home/pwuser ; npx --yes playwright@1.56.1 install && npx playwright@1.56.1 run-server --port 8888 --host 0.0.0.0 --path /ws"
        environment:
          DEBUG: "pw:*"
        user: pwuser
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: bundle install
      - run:
          name: Generate API
          command: bundle exec ruby development/generate_api.rb
      - run:
          name: Wait for Playwright server
          command: |
            timeout=60
            elapsed=0
            while ! nc -z localhost 8888; do
              if [ $elapsed -ge $timeout ]; then
                echo "Timeout waiting for Playwright server"
                exit 1
              fi
              echo "Waiting for Playwright server... ($elapsed/$timeout seconds)"
              sleep 1
              elapsed=$((elapsed + 1))
            done
            echo "Playwright server is ready!"
      - run:
          name: Run tests
          command: |
            # First run without DEBUG
            if bundle exec rspec spec/integration/example_spec.rb --format json --out /tmp/rspec_results.json --format progress; then
              echo "All tests passed on first run"
              exit 0
            else
              echo "Some tests failed. Extracting failed examples..."

              # Extract unique failed example ids from JSON output
              failed_examples=$(ruby -rjson -e '
                results = JSON.parse(File.read("/tmp/rspec_results.json"))
                failed = results["examples"].select { |ex| ex["status"] == "failed" }
                unique_ids = failed.map { |ex| ex["id"] }.uniq
                puts unique_ids.join(" ")
              ')

              if [ -z "$failed_examples" ]; then
                echo "No failed examples found in results"
                exit 1
              fi

              echo "Re-running failed examples with DEBUG=1:"
              echo "$failed_examples"

              # Re-run only failed examples with DEBUG enabled
              export DEBUG=1
              bundle exec rspec $(echo "$failed_examples" | sed 's/\([^ ]*\)/--example-id \1/g')
            fi
          environment:
            BROWSER: chromium
            PLAYWRIGHT_WS_ENDPOINT: ws://localhost:8888/ws

workflows:
  testing:
    jobs:
      - test-remote
