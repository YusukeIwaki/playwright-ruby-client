version: 2.1

jobs:
  test-remote:
    docker:
      - image: cimg/ruby:3.4
      - image: mcr.microsoft.com/playwright:v1.56.1-noble
        command: /bin/sh -c "cd /home/pwuser ; npx --yes playwright@1.56.1 install && npx playwright@1.56.1 run-server --port 8888 --host 0.0.0.0 --path /ws"
        environment:
          DEBUG: "pw:*"
        user: pwuser
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: bundle install
      - run:
          name: Generate API
          command: bundle exec ruby development/generate_api.rb
      - run:
          name: Wait for Playwright server
          command: |
            timeout=60
            elapsed=0
            while ! nc -z localhost 8888; do
              if [ $elapsed -ge $timeout ]; then
                echo "Timeout waiting for Playwright server"
                exit 1
              fi
              echo "Waiting for Playwright server... ($elapsed/$timeout seconds)"
              sleep 1
              elapsed=$((elapsed + 1))
            done
            echo "Playwright server is ready!"
      - run:
          name: Run tests
          command: bundle exec rspec spec/integration/example_spec.rb
          environment:
            BROWSER: chromium
            DEBUG: 1
            PLAYWRIGHT_WS_ENDPOINT: ws://localhost:8888/ws

workflows:
  testing:
    jobs:
      - test-remote
